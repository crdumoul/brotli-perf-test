/*global document, Image, jQuery, navigator, npLib, setTimeout, sXDComm, window */

var bProd = !(/^(dev|qa|qa\-tech)\./.test(document.location.host)), // use prod settings on staging (as instructed!)...
	bRemote = true,
	CAPTURE,
	client_id_postmedia = '',
	delete_account = '',
	delete_account_help = '',
	i,
	janrain_capture_url = bProd ? "https://capture.canada.com" : "https://postmedia.dev.janraincapture.com",
	janrain_federate_url = bProd ? "https://sso.canada.com" : "https://postmedia-dev.janrainsso.com",
	JanrainSite,
	janrain_sites = [],
	light,
	lightbox_open = false,
	np8020Beacons,
	password_sent = '',
	//sSubdomain = /^((?:wp)?dev|qa(?:\-tech)?|(?:wp)?staging(?:\.www)?)\./.test(document.location.host) ? document.location.host.replace(/^(?:wp)?(dev|qa(?:\-tech)?|staging(?:\.www)?)\..*$/, '$1') : 'www',
	sSubdomain = /^((?:wp)?qa(?:\-tech)?|(?:wp)?staging(?:\.www)?)\./.test(document.location.host) ? document.location.host.replace(/^(?:wp)?(qa(?:\-tech)?|staging(?:\.www)?)\..*$/, '$1') : 'www',
	sHost = sSubdomain + '.' + (/financialpost/i.test(document.location.host) ? 'financial' : 'national') + 'post.com',
	sImgBase = 'http://www.nationalpost.com/images/members/',
	sesame = true,
	sXDComm = 'http://' + document.location.host + (/^ww3/i.test(document.location.host) ? '/wp' : '') +'/xdcomm/' + (/^(dev|qa|qa\-tech|staging|www|www)\./.test(document.location.host) ? 'index.html' : ''),
	url_temp = window.location.href,
	user_reg_internal_1 = '';

// Digital/EPaper site XDComm change
if (/^(digital|epaper)\./.test(document.location.host)) {
	//sXDComm = sXDComm.replace('/xdcomm/', '/' + document.location.host.replace(/^([^\.]+)\.(national|financial)post\.com$/, '$1') + '/xdcomm.html');
	sXDComm = sXDComm.replace('/xdcomm/', '/epaper/xdcomm.html');
}

bRemote = top.location !== document.location || !(/^(arts|business|fullcomment|life|news|opinion|rss|sports|www|www|ww3|(wp)?staging(?:\.www)?|dev|qa(\-tech)?)\.(financial|national)post\.com$/i.test(document.location.host));

JanrainSite = function (prefix, suffix, property_title, client_id) {
	this.prefix = prefix;
	this.suffix = suffix;
	this.property_title = property_title;
	this.client_id = client_id;
};

janrain_sites[janrain_sites.length] = new JanrainSite('financialpost', 'financialpost.com', 'Financial Post', bProd ? 'pk5jjphmutetmk6w2yghspy9hydtq5ms' : 'uxnp88fyhsjcf2en8vy3fnkdfpbu4f92');
janrain_sites[janrain_sites.length] = new JanrainSite('nationalpost', 'nationalpost.com', 'National Post', bProd ? 'hzncah6bsbsamru235dsu4t5da5648m7' : '8kwxpxwn6t9rav26pfq92anrtajzbwqa');

// figure out which JanrainSite we want and assign variables
for (i = 0; i < janrain_sites.length; i += 1) {
	if (window.location.hostname.toLowerCase().indexOf(janrain_sites[i].suffix) > 0) {
		//property_name = window.location.hostname.toLowerCase();
		//property_title = janrain_sites[i].property_title;
		client_id_postmedia = janrain_sites[i].client_id;
		break;
	}
}

function deleteAccountScreens() {
	jQuery.getScript('/scripts/sso/deletenotify.ashx', function () {
		jQuery("#account-delete-triggered").css("display", "none");
		jQuery("#almost-there").css("display", "block");
	});
}

// opens newsletter list **********************************************************
function openSesame(a) {
	var b = "#" + a,
		h = jQuery(b + " .sub-list-box").height() + 20;
	if (sesame) {
		if (a === "add-newsletter") {
			jQuery(b).animate({height: h + "px"}, 500);
		} else {
			jQuery(b).animate({height: h + "px"}, 350);
		}
		sesame = false;
		jQuery("." + a + " img").attr("src", sImgBase + "subscribe_arrow_down.png");
	} else {
		if (a === "add-newsletter") {
			jQuery(b).animate({height: "0px"}, 500);
		} else {
			jQuery(b).animate({height: "0px"}, 350);
		}
		sesame = true;
		jQuery("." + a + " img").attr("src", sImgBase + "subscribe_arrow_right.png");
	}
}

// light box *****************************************************************************
light = {
	getHtml: function (aa) {
		var b = "",
			box_basic;
		if (aa === "user_reg_internal_1t") {
			b = b + user_reg_internal_1;
		}
		box_basic = '<div class="lb">' +
			'<div class="lb-top">' +
			'<a class="close-button" href="javascript:light.unmask(jQuery(\'body\'));"><img src="' + sImgBase + 'filler.gif" /></a>' +
			'<div class="paper-logo"><img src="http://www.' + (/financialpost/i.test(document.location.host) ? 'financial' : 'national') + 'post.com/images/members/logo_members.jpg"></div>' +
			'</div>' +
			'<div class="lb-mid">' +
			'<div class="lb-mid-content">' + b + '</div>' +
			'<div class="lb-mid-bottom">' +
			'<div class="powered">Powered by the canada.com Network</div>' +
			'canada.com is owned and operated by Postmedia Network Inc., Canada\'s largest publisher by circulation of paid English-language daily newspapers. Its properties include daily newspapers in cities across Canada; the Victoria Times Colonist, Vancouver Sun, The Province (Vancouver), Calgary Herald, Edmonton Journal, Regina Leader-Post, Saskatoon StarPhoenix, Windsor Star, Ottawa Citizen, The Gazette (Montreal) and the National Post, as well as community newspapers and more than 50 websites including canada.com and Dose.ca. <a href="http://www.canada.com/aboutus/index.html">Learn More...</a>' +
			'</div>' +
			'</div>' +
			'<div class="lb-bottom"></div>' +
			'</div>';
		return box_basic;
	},
	
	getSingle: function (f) {
		var ee = "",
			single_box;
		
		jQuery('html, body').animate({scrollTop: 0}, 1000);
			
		if (f === "delete_account") {
			ee = ee + delete_account;
		} else if (f === "delete_account_help") {
			ee = ee + delete_account_help;
		}
		
		single_box = '<div class="lb">' +
			'<div class="lb-top">' +
			'<a class="close-button" href="javascript:light.unmask(jQuery(\'body\'));"><img src="' + sImgBase + 'filler.gif" alt="" /></a>' +
			ee +
			'<div class="lb-bottom"></div>' +
			'</div>';
		
		return single_box;
	},
	
	unmask: function (myOb) {
		myOb.find(".loadmask-msg, .loadmask").remove();
		myOb.removeClass("masked");
		myOb.removeClass("masked-relative");
		myOb.find("select").removeClass("masked-hidden");
		lightbox_open = false;
	},
	
	//mask start
	mask: function (myOb, c) {
		
		var b,
			d,
			viewportwidth,
			viewportheight;
		
		
		light.unmask(myOb);
		if (myOb.css("position") === "static") {
			myOb.addClass("masked-relative");
		}
		myOb.addClass("masked");
		d = jQuery('<div class="loadmask" onclick="light.unmask(jQuery(\'body\'));"></div>');
		
		if (navigator.userAgent.toLowerCase().indexOf("msie") > -1) {
			d.height(myOb.height() + parseInt(myOb.css("padding-top"), 10) + parseInt(myOb.css("padding-bottom"), 10));
			d.width(myOb.width() + parseInt(myOb.css("padding-left"), 10) + parseInt(myOb.css("padding-right"), 10));
		}
		if (navigator.userAgent.toLowerCase().indexOf("msie 6") > -1) {
			myOb.find("select").addClass("masked-hidden");
		}
		myOb.append(d);
		
		if (typeof window.innerWidth !== 'undefined') {
			viewportwidth = window.innerWidth;
			viewportheight = window.innerHeight;
		} else if (typeof document.documentElement !== 'undefined' && typeof document.documentElement.clientWidth !== 'undefined' && document.documentElement.clientWidth !== 0) {
			viewportwidth = document.documentElement.clientWidth;
			viewportheight = document.documentElement.clientHeight;
		} else {
			viewportwidth = document.getElementsByTagName('body')[0].clientWidth;
			viewportheight = document.getElementsByTagName('body')[0].clientHeight;
		}
		
		if (typeof c === "string") {
			b = jQuery('<div class="loadmask-msg" style="display:none"></div>');
			b.append("<div>" + c + "</div>");
			myOb.append(b);
			b.css("top", Math.round(viewportheight * 0.5 - (b.height() - parseInt(b.css("padding-top"), 10) - parseInt(b.css("padding-bottom"), 10)) * 0.5));
			b.css("left", Math.round((viewportwidth * 0.5 - (b.width() - parseInt(b.css("padding-left"), 10) - parseInt(b.css("padding-right"), 10)) * 0.5) - 40) + "px");
			b.show();
		}
		jQuery(".loadmask").css("height", jQuery(document).height() + "px");
		lightbox_open = true;
	}
}; // light end

/*  
===============================================================================
WResize is the jQuery plugin for fixing the IE window resize bug
...............................................................................
                                               Copyright 2007 / Andrea Ercolino
-------------------------------------------------------------------------------
LICENSE: http://www.opensource.org/licenses/mit-license.php
WEBSITE: http://noteslog.com/
===============================================================================
*/

(function ($) {
	$.fn.wresize = function (f) {
		var version = '1.1',
			width,
			wresize = {fired: false, width: 0};
		
		function resizeOnce() {
			if ($.browser.msie) {
				if (!wresize.fired) {
					wresize.fired = true;
				} else {
					version = parseInt(jQuery.browser.version, 10);
					wresize.fired = false;
					if (version < 7) {
						return false;
					} else if (version === 7) {
						//a vertical resize is fired once, an horizontal resize twice
						width = $(window).width();
						if (width !== wresize.width) {
							wresize.width = width;
							return false;
						}
					}
				}
			}
			return true;
		}
		
		function handleWResize(e) {
			if (resizeOnce()) {
				return f.apply(this, [e]);
			}
		}
		
		this.each(function () {
			if (this === window) {
				$(this).resize(handleWResize);
			} else {
				$(this).resize(f);
			}
		});
		return this;
	};

}(jQuery));

jQuery(window).wresize(function () {
	var b = jQuery(".loadmask-msg"),
		viewportwidth,
		viewportheight;
	
	if (typeof window.innerWidth !== 'undefined') {
		viewportwidth = window.innerWidth;
		viewportheight = window.innerHeight;
	} else if (typeof document.documentElement !== 'undefined' && typeof document.documentElement.clientWidth !== 'undefined' && document.documentElement.clientWidth !== 0) {
		viewportwidth = document.documentElement.clientWidth;
		viewportheight = document.documentElement.clientHeight;
	} else {
		viewportwidth = document.getElementsByTagName('body')[0].clientWidth;
		viewportheight = document.getElementsByTagName('body')[0].clientHeight;
	}
	
	jQuery(".loadmask").css("width", "100%");
	if (viewportheight < b.height()) {
		b.css("top", "0px");
	} else {
		b.css("top", Math.round(viewportheight * 0.5 - (b.height() - parseInt(b.css("padding-top"), 10) - parseInt(b.css("padding-bottom"), 10)) * 0.5));
	}
	b.css("left", Math.round((viewportwidth * 0.5 - (b.width() - parseInt(b.css("padding-left"), 10) - parseInt(b.css("padding-right"), 10)) * 0.5) - 40) + "px");
});

/* OLD
function handleNewRegistration(cmd, isVerified) {
	var fnc = function () {};
	if (isVerified) {
		// if isVerified is true, the user is logged in
		// show new user messaging and set the click events
		// on all the close buttons to the passed in cmd
		
		//create the onclick function from the passed in cmd for the 
		//click event on the mask
		if (cmd !== "") {
			eval('fnc = function() { ' + cmd + '}');
			jQuery('.loadmask').removeAttr('onclick').bind('click', fnc);
			
			//set the click event on the close/cancel links to the passed in cmd
			jQuery('.close-button').attr('href', 'javascript:' + cmd);
			jQuery('.cancel').attr('href', 'javascript:' + cmd);
			jQuery('#confirmation_24_Cont').attr('href', 'javascript:' + cmd);
		}
		
		//hide the iframe
		jQuery('#janrainFrame').hide();	
		//show the new messaging
		jQuery('#confirmation_24').show();
		jQuery('#newRegVerifiedMessage').show();
	} else {
		//hide the iframe
		jQuery('#janrainFrame').hide();
		
		//show the new messaging
		jQuery('#confirmation_24').show();
		jQuery('#newRegNotVerifiedMessage').show();
	}
}*/

function handleNewRegistration(cmd, isVerified) {
	var fnc = function () {};
	
	//create the onclick function from the passed in cmd for the 
	//click event on the mask
	if (cmd !== "") {
		eval('fnc = function() { ' + cmd + '}');
		jQuery('.loadmask').removeAttr('onclick').bind('click', fnc);
		
		//set the click event on the close/cancel links to the passed in cmd
		jQuery('.close-button').attr('href', 'javascript:' + cmd);
		jQuery('.cancel').attr('href', 'javascript:' + cmd);
		jQuery('#confirmation_24_Cont').attr('href', 'javascript:' + cmd);
	}
	
	//hide the iframe
	jQuery('#janrainFrame').hide();	
	//show the new messaging
	jQuery('#confirmation_24').show();
	jQuery('#newRegVerifiedMessage').show();
	jQuery('html, body').animate({scrollTop:0}, 1000);
}

function handleRecoverPasswordEmailSent() {
	jQuery("#janrainFrame").css("display", "none");
	jQuery(".forgot_password_sent").css("display", "block");
}

/*
function handleNewRegistration2(jargs) {
	var args = JSON.parse(jargs),
		fnc = function () {};
	
	if (args.isVerified) {
		// if isVerified is true, the user is logged in
		// show new user messaging and set the click events
		// on all the close buttons to the passed in cmd
		
		//create the onclick function from the passed in cmd for the 
		//click event on the mask
		
		if (args.cmd !== "") {
			eval('fnc = function() { ' + args.cmd + '}');
			jQuery('.loadmask').removeAttr('onclick').bind('click', fnc);
			
			//set the click event on the close/cancel links to the passed in cmd
			jQuery('.close-button').attr('href', 'javascript:' + args.cmd);
			jQuery('.cancel').attr('href', 'javascript:' + args.cmd);
			jQuery('#legacyChange_Cont').attr('href', 'javascript:' + args.cmd);
		}
		//hide the iframe
		jQuery('#janrainFrame').hide();
		//show the new messaging
		jQuery('#confirmation_24').show();
		jQuery('#newRegVerifiedMessage').show();
		jQuery('html, body').animate({scrollTop: 0}, 1000);
	} else {
		//hide the iframe
		jQuery('#janrainFrame').hide();
		
		//show the new messaging
		jQuery('#confirmation_24').show();
		jQuery('html, body').animate({scrollTop: 0}, 1000);
		jQuery('#newRegNotVerifiedMessage').show();
	}
}

function handleNotVerified() {
	//hide the iframe
	jQuery('#janrainFrame').hide();
	
	//show the new messaging
	jQuery('#not_verified_login').show();
}
*/

//used by Janrain to resize the iframe window
CAPTURE = {
	resize: function (jargs) {
		var args = JSON.parse(jargs);
		if (lightbox_open) {
			jQuery(".theFrame").css({'width': '600px', 'height': args.h + 'px'});
		} else {
			jQuery('#editprofile_iframe').css({'width': '100%', 'height': args.h + 'px'});
		}
	}
};

/* NP ADDITIONS */

/* loginstatusbar */

function handlePostLogin(returnUrl) {
	
	//console.log('handlePostLogin()');
	
	var oL = window.location,
		bDev = (/^(dev|qa(\-tech)?|staging|wp(dev|staging)|ww3)\./i.test(oL.host)),
		bFP = /financialpost/i.test(oL.host),
		bLego = (/^(dev|qa(\-tech)?|staging|www|www)\./i.test(oL.host)),
		aSignIns = [],
		i,
		iLoads = 0,
		reHost = new RegExp('^' + oL.hostname, 'i'),
		oLoads = {},
		sUrl = oL.href;//,
		//bReloaded = false; // used to prevent double iframe onload call
	
	if (bFP || bLego) {
		aSignIns.push((bDev ? 'staging' : 'www') + '.nationalpost.com/sso-check/index.html');
	}
	if (!bFP || bLego) {
		aSignIns.push((bDev ? 'staging' : 'www') + '.financialpost.com/sso-check/index.html');
	}
	aSignIns.push((bDev ? 'wpstaging' : 'business') + '.financialpost.com/sso-check/?origin=none');
	aSignIns.push((bDev ? 'wpstaging' : 'news') + '.nationalpost.com/sso-check/?origin=none');
	iLoads = aSignIns.length - 1,
	
	// send to WP for thirdparty logins
	function reload() {
		
		var sUrl = oL.href;
		
		/*
		if (bReloaded) {
			return;
		}
		bReloaded = true;
		*/
		
		// send to home on certain actions
		if (oL.href.indexOf('/members/account-verified.html') > -1 || 
			oL.href.indexOf('/members/cancel-deletion.html') > -1 || 
			oL.href.indexOf('/members/reset-password-complete.html') > -1) {
			sUrl = '/';
		}
		
		/*
		if (bLego) {
			sUrl = 'http://' + (bDev ? 'wpstaging' : (bFP ? 'business' : 'news')) + '.' + (bFP ? 'financial' : 'national') + 'post.com/sso-check/?origin=' + encodeURIComponent(sUrl);
		}
		*/
		
		window.location = sUrl;
	}
	
	// load opposite Lego page first
	//
	//reload();
	
	
	
	
	
	
	
	
	
	
	
	
	// load others
	function ssoInstanceDone() {
		
		var oF = arguments[0].currentTarget,
			sSrc = oF.src
			id = sSrc.replace(/[^a-z]+/, '');
		
		if (iLoads <= 0) {
			return;
		}
		
		// increment load count (one load is when iframe is rendered, one is when page is loaded)
		if (oLoads[id]) {
			oLoads[id] += 1;
		} else {
			oLoads[id] = 1;
		}
		
		console.log('iframe loaded: ' + sSrc);
		
		// check if we've loaded twice
		sSrc = sSrc.replace('http://', '');
		if (oLoads[id] === 2) {
			oF.parentNode.removeChild(oF);
			iLoads -= 1;
		}
		
		console.log(oLoads[id] + ' times');
		console.log('iLoads = ' + iLoads);
		if (iLoads <= 0) {
			console.debug(oLoads);
			console.debug(oF);
		}

		// all loads done
		if (iLoads <= 0) {
			console.log('sso iframe loading done: ' + sSrc);
			
			// send to home on certain actions
			if (oL.href.indexOf('/members/account-verified.html') > -1 || 
				oL.href.indexOf('/members/cancel-deletion.html') > -1 || 
				oL.href.indexOf('/members/reset-password-complete.html') > -1) {
				sUrl = '/';
			}
			
			window.location = returnUrl ? returnUrl : sUrl;
		}
	}
	
	for (i = 0; i < aSignIns.length; i += 1) {
		if (!reHost.test(aSignIns[i])) {
			console.log('load iframe: ' + aSignIns[i]);
			jQuery('<iframe src="http://' + aSignIns[i] + '" class="npHide"></iframe>').appendTo('body').load(ssoInstanceDone);
		}
	}
	
	
	
	
	
	
	/*
	// reload SP/WP story page after logging in, for Pluck (NP only) and the chance of Facebook (FP only)
	} else if (/\d+\/story\.html/.test(document.location.pathname) || /\/\d{4}\/\d{2}\/\d{2}\/[^\/]+\//.test(document.location.pathname)) {
		window.location.reload();
		
	} else {
		
		// change the login status bar to reflect a logged in state
		jQuery.getScript(document.location.protocol + '//' + document.location.host + "/scripts/sso/user.ashx?format=json&callback=renderLoginStatusBar");
		
		// hide the login lightbox
		light.unmask(jQuery('body'));
	}
	*/
}
function handlePostLogout() {
	
	//console.log('handlePostLogout()');
	
	// leave members area, idc areas
	if (/^\/members\//i.test(window.location.pathname) || /^\/markets\/(news\-alerts|portoflio|watchlist)\//i.test(window.location.pathname)) {
		window.location = '/';
		
	// reload page after logging out, for Pluck (NP story/blog pages), and all FP (watchlist, comments)
	} else {//if (/financialpost/.test(document.location.host) || (/nationalpost/.test(document.location.host) && (/\d+\/story\.html/.test(document.location.pathname) || /\d{4}\/\d{2}\/\d{2}\/[^\/]+\//.test(document.location.pathname)))) {
		window.location = window.location.href.replace(/(#.+)?$/, '');
		
	/*} else {
		
		// change the login status bar to reflect a logged out state
		jQuery.getScript(document.location.protocol + '//' + sHost + "/scripts/sso/user.ashx?format=json&callback=renderLoginStatusBar");
		
		// remove the hidden logout iframe to keep things clean
		setTimeout(function () {
			jQuery("#iframe_logout").remove();
		}, 10000); //in 10 seconds, the iframe will close
		*/
	}
}
/* OLD
function dologout() {
	var sUrl = document.location.protocol + '//' + sHost + '/scripts/sso/logout.ashx';
	// create the hidden logout iframe
	if (bRemote) {
		document.location = sUrl + '?returnURL=' + encodeURIComponent(document.location.href);
	} else {
		jQuery('<iframe id="iframe_logout" src="' + sUrl + '?iframe=true" class="npHide"></iframe>').appendTo('body');
	}
}*/
function dologout() {
	var bWP = /^(arts|business|fullcomment|life|news|opinion|rss|sports|wp(dev|staging)|ww3)\./i.test(window.location.host),
		sLegoUrl = document.location.protocol + '//' + sHost + '/scripts/sso/logout.ashx',
		sWPUrl = 'http://' + document.location.host + '/signout/';
	
	// create the hidden logout iframe
	if (bRemote || (bWP && /financialpost/.test(document.location.host))) {
		document.location = sLegoUrl + '?returnURL=' + encodeURIComponent(document.location.href);
	} else if (bWP) {
		jQuery('<iframe id="iframe_logout" src="' + sWPUrl + '?iframe=true" class="npHide"></iframe>').appendTo('body');
	} else {
		jQuery('<iframe id="iframe_logout" src="' + sLegoUrl + '?iframe=true" class="npHide"></iframe>').appendTo('body');
	}
}
function renderLoginStatusBar(user) {
	var bWP = /^(arts|business|fullcomment|life|news|opinion|rss|sports|wp(dev|staging)|ww3)\./i.test(window.location.host),
		oStatusBar = document.getElementById('npCcnLogin'),
		sRedirect = document.location.href.replace(/(\?layer=true.+)?$/, ''),
		sHtml = '',
		sLink,
		sLoc = top.location === document.location ? document.location.href : '';
	
	sLink = bRemote ? 'href="http://' + sHost + '/index.html?layer=true' + (sLoc.length > 0 ? '&returnurl=' + encodeURIComponent(sLoc) : '') + '"' : 'onclick="javascript:light.mask(jQuery(body), light.getHtml(\'user_reg_internal_1t\'));return false"';
	
	user = user.User;
	
	if (user.IsLoggedIn) {
		//statusBarHtml += 'Hello <a href="http://' + sHost + '/members/edit-profile.html"><strong>' + user.DisplayName + '</strong></a>' +
		sHtml += 'Hello <strong>' + (user.FirstName.length > 0 ? user.FirstName : user.DisplayName) + '</strong>' +
			' | <a href="http://' + sHost + '/members/edit-profile.html">Edit Profile</a>' +
			' | <a href="#Sign-out" onclick="javascript:dologout();return false">Sign out</a>';
		np8020Beacons();
	} else {
		
		// FP
		if (/financialpost/.test(document.location.host)) {
			
			// dissallow redirect to certain pages
			sRedirect = /\/members\/(account\-verified|cancel\-deletion|reset\-password\-complete)\.html/i.test(sRedirect) ? document.location.href.replace(/^(.+\/)members\/.+$/, '$1') : sRedirect;
			
			/* force sign in on blogs
			if (!bWP) {
				sRedirect = 'http://'+(/^(dev|qa|staging)\./i.test(document.location.host) ? 'wpstaging' : 'business') + '.financialpost.com/sso-check/?origin=' + encodeURIComponent(sRedirect);
			}*/
			
			// sign in links
			if (bWP) {
				sHtml += '<a href="http://www.nationalpost.com/index.html?layer=true&returnurl=' + encodeURIComponent(sRedirect) + '">Sign in</a>' +
				' | <a href="http://www.nationalpost.com/index.html?layer=true&returnurl=' + encodeURIComponent(sRedirect) + '">Register today</a>';
			} else {
				/*sHtml += '<a href="http://' + document.location.host + document.location.pathname + '?layer=true&provider=idc&returnurl=%2fportfolio%2fsummary.idms%3fredirectUrl%3d' + encodeURIComponent(sRedirect) + '">Sign in</a>' +
					' | <a href="http://' + document.location.host + document.location.pathname + '?layer=true&provider=idc&returnurl=%2fportfolio%2fsummary.idms%3fredirectUrl%3d' + encodeURIComponent(sRedirect) + '">Register today</a>';*/
				sHtml += '<a href="http://www.nationalpost.com/index.html?layer=true&provider=idc&returnurl=%2fportfolio%2fsummary.idms%3fredirectUrl%3d' + encodeURIComponent(sRedirect) + '">Sign in</a>' +
					' | <a href="http://www.nationalpost.com/index.html?layer=true&provider=idc&returnurl=%2fportfolio%2fsummary.idms%3fredirectUrl%3d' + encodeURIComponent(sRedirect) + '">Register today</a>';
			}
			
		// NP
		} else {
			sHtml += '<a ' + (!bRemote ? 'href="#Sign%20In"' : '') + sLink + '>Sign in</a>' +
				' | <a ' + (!bRemote ? 'href="#Register"' : '') + sLink + '>Register today</a>';
		}
	}
	if (oStatusBar) {
		oStatusBar.innerHTML = '<a href="#Digital%20Access" onclick="$.pressplus.f.pop(\'login\');return false">Digital Access</a> | ' + sHtml;
	}
}


/* reset-password.html */

function handleResetPassword() {
	window.location = '/members/reset-password-complete.html';
}

function handleLegacyFirstLogin(cmd) {
	
	// create the onclick function from the passed in cmd for the click event on the mask
	if (cmd !== '') {
		eval('var fnc = function() { ' + cmd + '}');
		jQuery('.loadmask').removeAttr('onclick').bind('click', fnc);
		
		//set the click event on the close/cancel links to the passed in cmd
		jQuery('.close-button').attr('href', 'javascript:' + cmd);
		jQuery('.cancel').attr('href', 'javascript:' + cmd);
		jQuery('#legacyChange_Cont').attr('href', 'javascript:' + cmd);
	}
	
	//hide the iframe
	jQuery('#janrainFrame').hide();
	
	//show the new messaging
	jQuery('#legacyChange').show();
	jQuery('html, body').animate({scrollTop: 0}, 1000);
}








// NEW AS OF 11/9/7:

// get query param value
function getQS(key, def) {
	var regex,
		qs;
	if (typeof def === 'undefined') {
		def = '';
	}
	key = key.replace(/\[/g, '\\[').replace(/\]/g, '\\]');
	regex = new RegExp('[?&]' + key + '=([^&#]*)');
	qs = regex.exec(window.location.href);
	return qs === null ? def : qs[1];
}

function processPostLogin(jargs) {
	
	var args = JSON.parse(jargs),
		provider = getQS('provider'),
		brand = getQS('brand'),
		returnUrl = getQS('returnurl');
	
	if (provider !== "") {
		if (args.isNew) {
			handleNewRegistration('document.location.href = "http://' + sHost + '/scripts/sso/provider.ashx?provider=' + provider + ((brand !== "") ? '&brand=' + brand : '') + ((returnUrl !== "") ? '&returnurl=' + returnUrl : '') + '";', args.isVerified);
		} else if (args.isLegacy) {
			if (handleLegacyFirstLogin) {
				handleLegacyFirstLogin('document.location.href = "http://' + sHost + '/scripts/sso/provider.ashx?provider=' + provider + ((brand !== "") ? '&brand=' + brand : '') + ((returnUrl !== "") ? '&returnurl=' + returnUrl : '') + '";');
			} else {
				//document.location.href = 'http://' + sHost + '/scripts/sso/provider.ashx?provider=' + provider + ((brand !== "") ? '&brand=' + brand : '') + ((returnUrl !== "") ? '&returnurl=' + returnUrl : '');
				handlePostLogin('http://' + sHost + '/scripts/sso/provider.ashx?provider=' + provider + ((brand !== "") ? '&brand=' + brand : '') + ((returnUrl !== "") ? '&returnurl=' + returnUrl : ''));
			}
		} else {
			//document.location.href = 'http://' + sHost + '/scripts/sso/provider.ashx?provider=' + provider + ((brand !== "") ? '&brand=' + brand : '') + ((returnUrl !== "") ? '&returnurl=' + returnUrl : '');
			handlePostLogin('http://' + sHost + '/scripts/sso/provider.ashx?provider=' + provider + ((brand !== "") ? '&brand=' + brand : '') + ((returnUrl !== "") ? '&returnurl=' + returnUrl : ''));
		}
	} else if (returnUrl !== "") {
		returnUrl = decodeURIComponent(returnUrl);
		if (args.isNew) {
			handleNewRegistration('document.location.href = "' + returnUrl + '";', args.isVerified);
		} else if (args.isLegacy) {
			if (handleLegacyFirstLogin) {
				handleLegacyFirstLogin('document.location.href = "' + returnUrl + '";');
			} else {
				handlePostLogin(returnUrl);
			}
		} else {
			handlePostLogin(returnUrl);
		}
	} else {
		if (args.isNew) {
			handleNewRegistration('handlePostLogin();', args.isVerified);
		} else if (args.isLegacy) {
			if (handleLegacyFirstLogin) {
				handleLegacyFirstLogin('handlePostLogin();');
			} else {
				handlePostLogin();
			}
		} else {
			handlePostLogin();
		}
	}
}

// 80/20 beacons
np8020Beacons = function () {
	
	var bNP = window.location.host.indexOf('financialpost') < 0,
		id,
		iValue,
		publishEvent,
		sDom = window.location.host.replace(/^(?:[^\.]+\.)*([^\.]+\.\w+)$/, '$1'),
		sPath = window.location.pathname.replace(/^\/(category\/)?/, ''),
		sSubD = window.location.host.replace(/^([^\.]+).*$/, '$1');
	
	publishEvent = function (ha, eid, key, id, value) {
		var qStr,
			img;
		if (value == undefined || value == null) {
			value = '';
		}
		qStr = '?' + key + '=' + id + '&eid=' + eid + '&v=' + value + '&t=' + new Date().getTime();
		img = new Image();
		img.src = ha + '/mcctrk/cec/t.gif' + qStr;
		img.onload;
	};
	
	// NP
	if (bNP) {
		
		// order is important!
		
		// news
		if (/^news\//i.test(sPath) || sSubD === 'news') {
			id = 1459;
			iValue = 0.03;
			
		// opinion
		} else if (/^opinion\//i.test(sPath) || sSubD === 'fullcomment') {
			id = 1460;
			iValue = 0.04;
			
		// arts
		} else if (/^arts\//i.test(sPath) || sSubD === 'arts') {
			id = 1461;
			iValue = 0.05;
			
		// homes
		} else if (/^(posted\-)?homes\//i.test(sPath)) {
			id = 1464;
			iValue = 0.08;
			
		// cars
		} else if (/^(cars|posted-driving)\//i.test(sPath)) {
			id = 1465;
			iValue = 0.09;
			
		// life
		} else if (/^life\//i.test(sPath) || sSubD === 'life') {
			id = 1462;
			iValue = 0.06;
			
		// sports
		} else if (/^sports\//i.test(sPath) || sSubD === 'sports' || sDom === 'stats.com') {
			id = 1463;
			iValue = 0.07;
			
		// multimedia
		} else if (/^multimedia\//i.test(sPath)) {
			id = 1466;
			iValue = 0.1;
			
		// classifieds
		} else if (/^classifieds\//i.test(sPath) || sSubD === 'classifieds' || sDom === 'flyertown.com' || sDom === 'legacy.com' || sDom === 'oodle.com') {
			id = 1467;
			iValue = 0.11;
			
		// site map
		} else if (/^sitemap\//i.test(sPath)) {
			id = 1468;
			iValue = 0.12;
			
		// today's paper
		} else if (/^todays\-paper\//i.test(sPath)) {
			id = 1470;
			iValue = 0.14;
			
		// delivery
		} else if (sSubD === 'subscriptions') {
			id = 1471;
			iValue = 0.15;
			
		// contact
		} else if (/^contact\//i.test(sPath)) {
			id = 1472;
			iValue = 0.16;
			
		// digital paper
		} else if (sSubD === 'digital') {
			id = 1473;
			iValue = 0.17;
			
		// home
		} else if (sPath === '') {
			id = 1457;
			iValue = 0.01;
		}
		
	// FP
	} else {
			
		// news
		if (/^news\//i.test(sPath)) {
			id = 1478;
			iValue = 0.002;
			
		// opinion
		} else if (/^opinion\//i.test(sPath) || sSubD === 'opinion') {
			id = 1479;
			iValue = 0.003;
			
		// markets
		} else if (/^markets\//i.test(sPath)) {
			id = 1480;
			iValue = 0.004;
			
		// investing
		} else if (/^investing\//i.test(sPath)) {
			id = 1481;
			iValue = 0.005;
			
		// personal finance
		} else if (/^personal\-finance\//i.test(sPath)) {
			id = 1482;
			iValue = 0.006;
			
		// tech desk
		} else if (/^fp\-tech\-desk\//i.test(sPath)) {
			id = 1483;
			iValue = 0.007;
			
		// legal post
		} else if (/^legal\-post\//i.test(sPath)) {
			id = 1484;
			iValue = 0.008;
			
		// executive
		} else if (/^executive\//i.test(sPath)) {
			id = 1485;
			iValue = 0.009;
			
		// entrepreneur
		} else if (/^entrepreneur\//i.test(sPath)) {
			id = 1486;
			iValue = 0.0001;
			
		// site map
		} else if (/^sitemap\//i.test(sPath)) {
			id = 1487;
			iValue = 0.00011;
			
		// home
		} else if (sPath === '') {
			id = 1477;
			iValue = 0.001;
		}
	}
	
	if (id) {
		publishEvent('http://np.8020solutions.net:80', id.toString(), 'sid', encodeURIComponent(npLib.cookieGet('AT').replace(/^.*e=([^&]+).*$/, '$1')), iValue);
	}
};

// detect parameter when page loads
jQuery(document).ready(function () {
	if (window.location.search.indexOf('layer=true') >= 0) {
		light.mask(jQuery('body'), light.getHtml('user_reg_internal_1t'));
	}
	jQuery.getScript(document.location.protocol + '//' + sHost + "/scripts/sso/user.ashx?format=json&callback=renderLoginStatusBar");
});

// Freeskreen
FSK_callback_join = function () {
	FSK_signin();
};
FSK_callback_login = function () {
	FSK_signin();
};
FSK_callback_logout = function () {
	dologout();
};
FSK_signin = function () {
	console.log("FSK_sigin");
	var oA = npJ('#npCcnLogin a').eq(1);
	if (oA.attr('onclick')) {
		oA.click();
	} else {
		window.location = oA.attr('href');
	}
};

user_reg_internal_1 = '<div class="stroke-h"></div>' +
	'<div class="iframeContainer">' +
		'<iframe id="janrainFrame" name="janrainFrame" class="theFrame" src="' + janrain_capture_url + '/oauth/signin?response_type=code&client_id=' + client_id_postmedia + '&redirect_uri=http%3a%2f%2f' + sHost + '%2fscripts%2fsso%2fpostlogin.ashx&xd_receiver=' + encodeURIComponent(sXDComm) + (/^(digital|epaper)\./i.test(document.location.host) ? '&state=' + encodeURIComponent('brand_receiver=' + sXDComm.replace('xdcomm.html', 'pdm_xdcomm.html')) : '') + '&recover_password_callback=handleRecoverPasswordEmailSent" scrolling="no" frameBorder="no" allowtransparency="true"></iframe>' +
		'<div class="forgot_password_sent">' +
			'<div class="profile-title">Reset your password</div>' +
			'<div class="npClear">&nbsp;</div><br>' +
			'<div class="profile-desc">' +
				'Check your email.<div class="npClear">&nbsp;</div><br>' +
				'We\'ve sent you an email with a link where you can reset your password.<div class="npClear">&nbsp;</div><br>' +
				'Having trouble? Search the <a href="http://wwww.canada.com/aboutus/help/members_help.html">Help section</a> or <a href="mailto:feedback@postmedia.com">contact us</a>.' +
				'<div class="npClear">&nbsp;</div><br>' +
				'<a href="javascript:light.unmask(jQuery(\'body\'));"><img src="' + sImgBase + 'close.jpg" alt="Close" /></a>' +
			'</div>' +
		'</div>' +
	'</div>' +
	'<div id="legacyChange" class="form-iframe-container npHide">' +
		'<div class="profile-title">We\'ve made membership easy</div>' +
		'<div class="npClear">&nbsp;</div><br>' +
		'<div class="profile-desc">' +
			'Link your networking accounts.<div class="npClear">&nbsp;</div><br>' +
			'<div style="font-size:12px; color:#666;">' +
				'You can choose to sign into your account with your login and password from other popular sites like Facebook, Twitter or LinkedIn.  And if you want to make a comment and have it posted to Facebook or Twitter, you can link the accounts in your profile.  Your comments will automatically appear where you want them.' +
			'</div>' +
			'<div class="npClear">&nbsp;</div><br>' +
			'With your membership, you can<div class="npClear">&nbsp;</div><br>' +
			'<div style="font-size:12px; color:#666;">' +
				'- Access your ePaper subscription<br>'+
				'- Take advantage of special offers from advertisers<br>' +
				'- Sign up for member-only newsletters and daily news alerts<br>' +
				'- Enter contests for a chance to win prizes<br>' +
				'- Post your comments on news articles<br>' +
				'- Send interesting links and articles to friends on other networks like Facebook or Twitter<br>' +
			'</div>' +
			'<div class="npClear">&nbsp;</div><br>' +
			'<a href="javascript:light.unmask(jQuery(\'body\'));" id="legacyChange_Cont"><img src="' + sImgBase + 'button-continue.jpg" alt="Continue" /></a>' +
		'</div>' +
	'</div>' +
	'<div class="form-iframe-container" id="confirmation_24">' +
		'<div class="profile-title">Thank you for registering</div>' +
		'<div class="npClear">&nbsp;</div><br>' +
		'<div id="newRegNotVerifiedMessage" class="profile-desc">' +
			'<div class="npClear">&nbsp;</div><br>' +
			'Thank you for registering. Your membership account is now active. With your membership, you can now sign in to'+
			'<div class="profile-desc" style="padding-left:20px;">'+
			'- Access your ePaper subscription<br>'+
			'- Take advantage of special offers from advertisers<br>'+
			'- Sign up for member-only newsletters and daily news alerts<br>'+
			'- Enter contests for a chance to win prizes<br>'+
			'- Post your comments on news articles<br>'+
			'- Send interesting links and articles to friends on other networks like Facebook or Twitter'+
			'</div>'+
			'<div class="npClear">&nbsp;</div><br>' +
		'</div>' +
		'<div id="newRegVerifiedMessage" class="profile-desc">' +
			'<div class="npClear">&nbsp;</div><br>' +
			'Thank you for registering.  You are now ready to enjoy all the benefits of membership.' +
			'<div style="font-size:12px; color:#666;">' +
				'- Access your ePaper subscription<br>'+
				'- Take advantage of special offers from advertisers<br>' +
				'- Sign up for member-only newsletters and daily news alerts<br>' +
				'- Enter contests for a chance to win prizes<br>' +
				'- Post your comments on news articles<br>' +
				'- Send interesting links and articles to friends on other networks like Facebook or Twitter' +
			'</div>' +
			'<div class="npClear">&nbsp;</div><br>' +
		'</div>' +
		'<div class="profile-desc">' +
			'<a href="javascript:light.unmask(jQuery(\'body\'));" id="confirmation_24_Cont"><img src="' + sImgBase + 'button-continue.jpg" alt="Continue" /></a>' +
//				'<div id="notVerifiedMessage" class="profile-desc">Please note that your new account registration must be confirmed within 24 hours.  An email has been sent to the email address you provided.  Please open the email and follow the instructions to click on the link provided and verify your registration.  If the registration is not verified in the next 24 hours, this account will be disabled for your security.' +
			'<div class="npClear">&nbsp;</div><br>' +
		'</div>' +
	'</div>' +
	'<div class="form-iframe-container" id="not_verified_login">' +
		'<div class="profile-title">Account not verified</div>' +
		'<div class="npClear">&nbsp;</div><br>' +
		'<div class="profile-desc">' +
			'<div class="npClear">&nbsp;</div><br>' +
			'Our records show that this email account has not been verified. Please check the inbox of the email account you registered with for a verification email.' +
			'<div class="npClear">&nbsp;</div><br>' +
			'If you require another verification email to be sent, please click <a href="/members/request-verification.html">here</a>.' +
			'<div class="npClear">&nbsp;</div><br>' +
		'</div>' +
	'</div>' +
	'<div class="npClear">&nbsp;</div>' +
	'<div class="bottom-links">' +
		'<a href="http://www.canada.com/aboutus/privacy.html" class="privacy">Concerned about privacy?</a>' +
		'<a href="http://www.canada.com/aboutus/membership/" class="privacy" style="left:300px">FAQ</a>' +
		'<a href="javascript:light.unmask(jQuery(\'body\'));" class="cancel">Close</a>' +
		'<div class="npClear">&nbsp;</div>' +
	'</div>';

password_sent = 
	'<div class="stroke-h"></div>' +
	'<div class="signin-desc">Register a new account.</div>' +
	'<div class="form-iframe-container">' +
		'<iframe class="theFrame" src="' + janrain_capture_url + '/oauth/register?response_type=code&redirect_uri=http%3A//' +sHost+'/oauth_redirect&client_id=p4s35uatbvmhb7u4tej9ut9zt5yf8xtd&xd_receiver=' + encodeURIComponent(sXDComm) + '" scrolling="no" frameBorder="no" allowtransparency="true"></iframe>' +
	'</div>' +
	'<div class="npClear">&nbsp;</div>' +
	'<div class="bottom-links">' +
		'<a href="javascript:light.unmask(jQuery(\'body\'));" class="cancel">Close</a>' +
		'<div class="npClear">&nbsp;</div>' +
	'</div>';

delete_account = 
	'<div class="profile-top-title2">Delete My Account</div>' +
	'<div class="npClear">&nbsp;</div>' +
	'</div>' +
	'<div class="lb-mid">' +
		'<div class="lb-mid-content">' +
			'<div class="pad_20">' +
				'<div class="profile-desc-card" align="center" id="account-delete-triggered">' +
					'You\'ve indicated that you would like to delete your account. Are you sure?' +
					'<div class="npClear">&nbsp;</div><br />' +
					'<a href="javascript:light.unmask(jQuery(\'body\'));"><img src="' + sImgBase + 'cancel.jpg" alt="Close" /></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:deleteAccountScreens();"><img src="' + sImgBase + 'ok.jpg" alt="Ok" /></a>' +
				'</div>' +
				'<div class="profile-desc-card" align="center" id="almost-there">' +
					'You will be contacted shortly via email with important information concerning your member account, and to confirm your membership account deletion.' +
					'<div class="npClear">&nbsp;</div><br />' +
					'<a href="javascript:light.unmask(jQuery(\'body\'));"><img src="' + sImgBase + 'ok.jpg" alt="Ok" /></a>' +
				'</div>' +
				'<div class="npClear">&nbsp;</div>' +
			'</div>' +
			'<div class="npClear">&nbsp;</div>' +
			'<div class="bottom-links">' +
				'<a href="javascript:light.unmask(jQuery(\'body\'));" class="cancel">Close</a>' +
				'<div class="npClear">&nbsp;</div>' +
			'</div>' +
			'<div class="npClear">&nbsp;</div>' +
		'</div>' +
	'</div>';

delete_account_help = 
	'<div class="profile-top-title2">Delete Account Help</div>' +
	'<div class="npClear">&nbsp;</div>' +
	'</div>' +
	'<div class="lb-mid">' +
		'<div class="lb-mid-content">' +
			'<div class="pad_20">' +
				'<div class="profile-desc-card">' +
					'You will be contacted to verify your account deletion request. Please check your email inbox. Your member profile will be reviewed by one of our representatives. By deleting your account, various paid and unpaid services you have previously subscribed to will no longer be available including:' +
					'<div class="npClear">&nbsp;</div><br />' +
					'<div style="padding-left:20px; line-height:20px; font-size:12px;">' +
						'- Commenting on blogs, stories<br />' +
						'- Participating in online community social activities<br />' +
						'- Entering online contests<br />' +
						'- Access to online Digital Editions (paid service)<br />' +
						'- Access to convenient Subscriber Self-Serve online tools to help you manage your paid newspaper subscription(s)' +
					'</div>' +
					'<div class="npClear">&nbsp;</div><br /><br />' +
					'<div align="center"><a href="javascript:light.unmask(jQuery(\'body\'));"><img src="' + sImgBase + 'ok.jpg" alt="Okay" /></a></div>' +
				'</div>' +
				'<div class="npClear">&nbsp;</div>' +
			'</div>' +
			'<div class="npClear">&nbsp;</div>' +
		'</div>' +
	'</div>';
