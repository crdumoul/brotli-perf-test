rb.history={_handlers:new rb.UI.eventHandlerList(),_handlerID:"onStateChange",_suppressNextHashChangeEvent:false,pushState:function(b,a){rb.history._suppressNextHashChangeEvent=(a==true)?false:true;$.bbq.pushState(b)},getState:function(){var c=$.bbq.getState(true);var a={};for(var b in c){if(c.hasOwnProperty(b)){a[b.toLowerCase()]=c[b]}}return a},removeState:function(a,b){rb.history._suppressNextHashChangeEvent=(b==true)?false:true;$.bbq.removeState(a)},hasState:function(){var a=window.location.hash;return a.length>1},addStateChange:function(a){rb.history._handlers.addHandler(rb.history._handlerID,a)},removeStateChange:function(a){rb.history._handlers.removeHandler(rb.history._handlerID,a)},raiseStateChange:function(a){var b=rb.history._handlers.getHandler(rb.history._handlerID);if(b){a=a||{};b(null,a)}},recordState:function(a,e,d,b){if(e!=null){var c={};c[a]=e;rb.history.pushState(c);if(d){rb.persistence.clientSession.set(a,e,b)}}else{rb.history.removeState(a);if(d){rb.persistence.clientSession.removeAll(a,b)}}},loadChangedState:function(b,e,f,c){var d=rb.history.getState();var a=rb.getPropDiff(b,d,e);if(rb.getPropCount(a)>0){if(f){rb.persistence.clientSession.save(a,c)}return a}if(f){var d=rb.persistence.clientSession.get(null,c);var a=rb.getPropDiff(b,d,e);if(rb.getPropCount(a)>0){rb.history.pushState(a);return a}}return null},clearState:function(b,a){rb.persistence.clientSession.removeAll(b,a);this.removeState(b,false)}};$(function(){$(window).bind("hashchange",function(a){if(rb.history._suppressNextHashChangeEvent){rb.history._suppressNextHashChangeEvent=false;return}rb.history.raiseStateChange({state:a.getState(),fragment:a.fragment})})});